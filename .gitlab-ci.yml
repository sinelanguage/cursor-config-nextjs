stages:
  - install
  - lint
  - type-check
  - test
  - security
  - build

variables:
  NODE_VERSION: '20'
  PNPM_VERSION: 'latest'
  CACHE_KEY: ${CI_COMMIT_REF_SLUG}-$CI_COMMIT_REF_SLUG

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .npm/cache/

image: node:${NODE_VERSION}

before_script:
  - npm ci --cache .npm/cache --prefer-offline

install_dependencies:
  stage: install
  script:
    - npm ci
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .npm/cache/

lint:
  stage: lint
  script:
    - npm run lint
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
    policy: pull

type-check:
  stage: type-check
  script:
    - npm run type-check
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
    policy: pull

test:
  stage: test
  script:
    - npm run test:ci -- --coverage --reporter=json
  coverage: '/(?<statements>\d+\.\d+%) covered/'
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
    policy: pull
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/lcov.info
    paths:
      - coverage/

test:integration:
  stage: test
  script:
    - npm run test:integration
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
    policy: pull

test:e2e:
  stage: test
  script:
    - npm install -g @playwright/test
    - npx playwright install --with-deps chromium
    - npm run test:e2e
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 1 week

security:
  stage: security
  script:
    - npm audit --audit-level=moderate
  allow_failure: true

snyk:
  stage: security
  image: snyk/snyk:latest
  variables:
    SNYK_TOKEN: $SNYK_TOKEN
  script:
    - snyk auth $SNYK_TOKEN
    - snyk test --severity-threshold=high
    - snyk code test --severity-threshold=medium
  allow_failure: true
  only:
    - merge_requests
    - main

build:
  stage: build
  script:
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
    policy: pull
  only:
    - main
    - merge_requests

pages:
  stage: deploy
  dependencies:
    - build
  script:
    - mkdir public
    - cp -r dist/* public/
  artifacts:
    paths:
      - public
  only:
    - main

